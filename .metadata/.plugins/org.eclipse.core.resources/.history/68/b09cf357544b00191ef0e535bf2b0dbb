import org.jdom2.*;
import org.jdom2.output.XMLOutputter;

import java.io.FileNotFoundException;
import java.io.FileOutputStream;
import java.io.IOException;
import java.lang.reflect.Field;


public class Serializer {
	Class currentClass;
	Object currentObject;
	Element currentRoot;
	Element classHolder;
	
	// SERIALIZE object passed in, and produce an XML
	public Document serialize(Object objectCreator)
	{
		Element root = new Element("Desesialized");
		
		//Create root element first
		for(int i = 0; i < ObjectCreator.objects.length; i++)
		{
			if(ObjectCreator.objects[i] == null) break;
			this.accessClass(ObjectCreator.objects[i], root);
		}
		//then create object one by one
		
		
		DocType type = new DocType("Deserialized");
		Document doc = new Document(root, type);

		// serialize with two space indents and extra line breaks
		try {
			XMLOutputter serializerr = new XMLOutputter();
			serializerr.output(doc, System.out);				 //or use System.out
			serializerr.output(doc, Main.fos);				 
		}
		catch (IOException e) {
			System.err.println(e);
		}
		return null;
	}
	
	private void accessClass(Object obj, Element root)
	{	
		currentClass = obj.getClass();
		currentRoot = root;
		currentObject = obj;
		
		this.serializeClass();
		
		
	}

	private void serializeClass() 
	{
		
		classHolder = new Element("object");
		
		int id = currentObject.hashCode();
		classHolder.setAttribute("ID", String.valueOf(id) );
		classHolder.setAttribute("Class", currentClass.getName());
		
		if(currentClass.getDeclaredFields().length > 0)
		{
			System.out.println("Found Fields");
			this.serializeFields();
		}
		
		currentRoot.addContent(classHolder);
	}
	
	private void serializeFields()
	{
		Field[] fields = currentClass.getDeclaredFields();
		System.out.println("This class has " + fields.length + " fields.");
		for(Field f : fields) {
			System.out.println("Adding field info");
			f.setAccessible(true);
			
			Element fieldElement = new Element("field");
			
			fieldElement.setAttribute("declaringclass", f.getDeclaringClass().toString());
			fieldElement.setAttribute("Name", f.getName());
			
			if(f.getType().isPrimitive())
			{
				try {
					System.out.println("Primitive type");
					fieldElement.addContent(new Element("value").setText(String.valueOf(f.getInt(currentObject))));
				} catch (IllegalArgumentException e) {
					// TODO Auto-generated catch block
					e.printStackTrace();
				} catch (IllegalAccessException e) {
					// TODO Auto-generated catch block
					e.printStackTrace();
				}
			}
			
			try {
				fieldElement.setText(String.valueOf(f.get(currentObject)));

			} catch (IllegalArgumentException | IllegalAccessException e) {
				e.printStackTrace();
			}
			
			classHolder.addContent(fieldElement);
		}
	}
}
